# Étape 1 — Build + Tests
FROM maven:3.9.6-eclipse-temurin-17 AS builder
WORKDIR /app

# Copie du pom.xml d'abord pour le cache des dépendances
COPY pom.xml .
RUN mvn -B -q -Dmaven.test.skip=true -DskipITs clean package

# Copie du reste du code
COPY src ./src

COPY config ./config

RUN mvn -B -e clean verify checkstyle:check

# Étape 2 — Runtime
FROM eclipse-temurin:17-jre-jammy AS runtime
WORKDIR /app

# Installer tini depuis les dépôts Ubuntu officiels
RUN apt-get update && \
    apt-get install -y --no-install-recommends tini && \
    rm -rf /var/lib/apt/lists/*

# Créer un utilisateur non-root
RUN groupadd --system api && useradd --system --create-home --gid api api

COPY --from=builder /app/target/*.jar app.jar
COPY --chmod=755 entrypoint.sh /app/entrypoint.sh

USER api
EXPOSE 8080

ENTRYPOINT ["/usr/bin/tini", "--", "/app/entrypoint.sh"]

